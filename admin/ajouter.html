<form id="ajouter-form" enctype="multipart/form-data">
  <label>Catégorie: <input name="categorie" required></label><br>
  <label>Nom: <input name="nom" required></label><br>
  <label>Région: <input name="region" required></label><br>
  <label>Ville: <input name="ville" required></label><br>
  <label>Quartier: <input name="quartier" required></label><br>
  <label>Adresse: <input name="adresse" required></label><br>
  <label>Description: <textarea name="description" required></textarea></label><br>
  <label>Images: <input type="file" name="images" accept="image/*" multiple required></label><br>
  <button type="submit">Ajouter le service</button>
</form>

<p id="resultat"></p>

<script type="module">
  const form = document.getElementById('ajouter-form');
  const resultat = document.getElementById('resultat');

  const SUPABASE_URL = "https://zsnovjyzgdyhvuctwozz.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...";
  const BUCKET = "services-images";

  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    
    const formData = new FormData(form);
    const images = formData.getAll("images");

    const uploadedImageUrls = [];

    for (const image of images) {
      const fileName = `${Date.now()}-${image.name}`;
      const { data, error } = await supabase.storage
        .from(BUCKET)
        .upload(fileName, image);

      if (error) {
        resultat.textContent = "Erreur lors de l'envoi de l'image";
        return;
      }

      const { data: publicUrl } = supabase
        .storage
        .from(BUCKET)
        .getPublicUrl(fileName);

      uploadedImageUrls.push(publicUrl.publicUrl);
    }

    // Envoyer les données + URLs au backend Supabase REST API
    const response = await fetch("/api/ajouter-service", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        categorie: formData.get("categorie"),
        nom: formData.get("nom"),
        region: formData.get("region"),
        ville: formData.get("ville"),
        quartier: formData.get("quartier"),
        adresse: formData.get("adresse"),
        description: formData.get("description"),
        images: uploadedImageUrls
      }),
    });

    const result = await response.json();

    if (response.ok) {
      resultat.textContent = "Service ajouté avec succès !";
      form.reset();
    } else {
      resultat.textContent = "Erreur : " + result.message;
    }
  });
</script>
